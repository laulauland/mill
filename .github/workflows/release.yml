name: Release
on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            bottle_tag: arm64_sequoia
          - os: ubuntu-latest
            bottle_tag: x86_64_linux
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Compile binary
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          bun build --compile packages/cli/src/bin/mill.ts --outfile mill-bin --define "__MILL_VERSION__=\"${VERSION}\""
      - name: Package bottle
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p "mill/${VERSION}/bin"
          cp mill-bin "mill/${VERSION}/bin/mill"
          tar czf "mill-${VERSION}.${{ matrix.bottle_tag }}.bottle.tar.gz" "mill/${VERSION}/"
      - uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.bottle_tag }}
          path: "*.bottle.tar.gz"

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
          files: "*.bottle.tar.gz"

  update-tap:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Update homebrew formula
        env:
          GH_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SOURCE_SHA=$(curl -sL "https://github.com/laulauland/mill/archive/refs/tags/v${VERSION}.tar.gz" | shasum -a 256 | cut -d' ' -f1)
          ARM64_SHA=$(shasum -a 256 "mill-${VERSION}.arm64_sequoia.bottle.tar.gz" | cut -d' ' -f1)
          LINUX_SHA=$(shasum -a 256 "mill-${VERSION}.x86_64_linux.bottle.tar.gz" | cut -d' ' -f1)

          cat > /tmp/mill.rb << RUBY
          class Mill < Formula
            desc "A runtime for executing TypeScript programs that can spawn agents"
            homepage "https://github.com/laulauland/mill"
            url "https://github.com/laulauland/mill/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SOURCE_SHA}"
            license "MIT"

            bottle do
              root_url "https://github.com/laulauland/mill/releases/download/v${VERSION}"
              sha256 arm64_sequoia: "${ARM64_SHA}"
              sha256 x86_64_linux: "${LINUX_SHA}"
            end

            depends_on "bun" => :build

            def install
              system "bun", "install", "--frozen-lockfile"
              system "bun", "build", "--compile", "packages/cli/src/bin/mill.ts", "--outfile", "mill", "--define", "__MILL_VERSION__=\"#{version}\""
              bin.install "mill"
            end

            test do
              assert_match "mill", shell_output("#{bin}/mill --help")
            end
          end
          RUBY

          sed -i 's/^          //' /tmp/mill.rb

          EXISTING_SHA=$(gh api repos/laulauland/homebrew-tap/contents/Formula/mill.rb --jq '.sha')
          gh api repos/laulauland/homebrew-tap/contents/Formula/mill.rb \
            --method PUT \
            --field message="mill ${VERSION}" \
            --field content="$(base64 -w0 /tmp/mill.rb)" \
            --field sha="${EXISTING_SHA}"
